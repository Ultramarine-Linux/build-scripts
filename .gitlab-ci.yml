image: registry.fedoraproject.org/fedora-minimal:35
services:
  - docker:dind

stages:
  - build
  - test
  - deploy

# only run these when files in kickstarts/ or gitlab-ci.yml was changed


iso-budgie:
  stage: build
  script:
    - microdnf install -y lorax-lmc-novirt vim-minimal pykickstart sudo
    - make flagship
  artifacts:
    paths:
    - build/
    when: always
  rules:
    - changes:
      - kickstarts/
      - gitlab-ci.yml


iso-cutefish:
  stage: build
  script:
    - microdnf install -y lorax-lmc-novirt vim-minimal pykickstart sudo
    - make SPIN=cutefish image
  artifacts:
    paths:
    - build/
    when: always
  rules:
    - changes:
      - kickstarts/
      - gitlab-ci.yml
# Generate live media
liveimage:
  stage: build
  before_script:
    - microdnf install -y lorax-lmc-novirt vim-minimal pykickstart sudo
  script:
    - make liveimage
  artifacts:
    paths:
    - build/
    when: always
  rules:
    - changes:
      - kickstarts/
      - gitlab-ci.yml

# deploy live media to server
deploy:
  stage: deploy
  dependencies:
    - liveimage
    - iso-budgie
    - iso-cutefish
  before_script:
    - microdnf install -y rsync openssh-clients lorax-lmc-novirt vim-minimal pykickstart sudo make
    - eval $(ssh-agent -s)
    - mkdir -p ~/.ssh
    - ssh-keyscan lapis.ultramarine-linux.org >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - echo "$SSH_PRIVATE_KEY" | ssh-add -
  script:
    - rsync -atvR --delete --progress build/liveimage/* gitlab@lapis.ultramarine-linux.org:/srv/lapis/results/ultramarine-35-x86_64
    - rsync -atvR --delete --progress build/image/* gitlab@lapis.ultramarine-linux.org:/srv/lapis/builds/nightly/$(date +%Y%m%d)/
  rules:
    - changes:
      - kickstarts/
      - gitlab-ci.yml
