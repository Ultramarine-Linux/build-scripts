image: registry.freedesktop.org/ultramarine-linux/installer-buildenv:34
services:
  - docker:dind

stages: 
  - build
  - test
  - deploy

iso-cyber:
  only:
    - $CI_COMMIT_MESSAGE == (?:(?!\[\!build\])(?:.|\n))*\[\!build\]
  stage: build
  script:
    - ./build.sh cyber
  artifacts:
    paths:
    - Ultramarine-Linux-Live.iso

file-test:
  only:
    - $CI_COMMIT_MESSAGE == (?:(?!\[\!build\])(?:.|\n))*\[\!build\]
  dependencies:
  - iso-cyber
  stage: test
  script:
    - file Ultramarine-Linux-Live.iso | grep bootable

kickstart-test:
  only:
    - $CI_COMMIT_MESSAGE == (?:(?!\[\!build\])(?:.|\n))*\[\!build\]
  stage: test
  script:
    - ksflatten --config kickstarts/ultramarine-${spin}.ks --output flattened.ks && sed -i 's/\r$//' flattened.ks
    - ksvalidator flattened.ks
