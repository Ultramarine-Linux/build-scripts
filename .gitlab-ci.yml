image: registry.fedoraproject.org/fedora-minimal:35
services:
  - docker:dind

stages:
  - build
  - test
  - deploy

# only run these when files in kickstarts/ or gitlab-ci.yml was changed


iso-budgie:
  stage: build
  script:
    - microdnf install -y lorax-lmc-novirt vim-minimal pykickstart sudo
    - make flagship
  artifacts:
    paths:
    - build/
    when: always
  rules:
    - changes:
        - .gitlab-ci.yml
        - kickstarts/*
      when: always


iso-cutefish:
  stage: build
  script:
    - microdnf install -y lorax-lmc-novirt vim-minimal pykickstart sudo
    - make SPIN=cutefish image
  artifacts:
    paths:
    - build/
    when: always
  rules:
    - changes:
        - .gitlab-ci.yml
        - kickstarts/*
      when: always
docker:
  stage: build
  before_script:
    - microdnf install -y moby-engine vim-minimal pykickstart sudo lorax-lmc-novirt
  script:
    - make docker
    # This will literally import the docker image
    # so we can just export this docker image right away
    # export the image into the registry
    - |
      cd oci-images/base
      #docker login -u $DOCKER_USER -p $DOCKER_PASS
      docker build -t gitlab.ultramarine-linux.org:5050/release-engineering/build-scripts .
      docker push gitlab.ultramarine-linux.org:5050/release-engineering/build-scripts
  artifacts:
    # the docker image is named "ultramarine"
    paths:
    - build/docker/ultramarine-docker.tar.xz
    when: always