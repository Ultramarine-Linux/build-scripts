image: registry.fedoraproject.org/fedora-minimal:35
services:
  - docker:dind

stages:
  - build
  - test
  - deploy

# only run these when files in kickstarts/ or gitlab-ci.yml was changed


iso-budgie:
  stage: build
  script:
    - microdnf install -y lorax-lmc-novirt vim-minimal pykickstart sudo
    - make flagship
  artifacts:
    paths:
    - build/
    when: always
  rules:
    - changes:
        - .gitlab-ci.yml
        - kickstarts/*
      when: always


iso-cutefish:
  stage: build
  script:
    - microdnf install -y lorax-lmc-novirt vim-minimal pykickstart sudo
    - make SPIN=cutefish image
  artifacts:
    paths:
    - build/
    when: always
  rules:
    - changes:
        - .gitlab-ci.yml
        - kickstarts/*
      when: always

docker:
  stage: build
  before_script:
    - microdnf install -y moby-engine vim-minimal pykickstart sudo lorax-lmc-novirt
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - make docker
    # This will literally build the image so we can just push it to the registry
    - |
      docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG .
      docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  artifacts:
    # the docker image is named "ultramarine"
    paths:
    - build/docker/ultramarine-docker.tar.xz
    when: always