image: registry.fedoraproject.org/fedora-minimal:35
services:
  - docker:dind

stages:
  - build
  - test
  - deploy

# only run these when files in kickstarts/ or gitlab-ci.yml was changed


iso-budgie:
  stage: build
  script:
    - microdnf install -y lorax-lmc-novirt vim-minimal pykickstart sudo
    - make flagship
  artifacts:
    paths:
    - build/
    when: always
  rules:
    - changes:
      - kickstarts/
      - gitlab-ci.yml


iso-cutefish:
  stage: build
  script:
    - microdnf install -y lorax-lmc-novirt vim-minimal pykickstart sudo
    - make SPIN=cutefish image
  artifacts:
    paths:
    - build/
    when: always
  rules:
    - changes:
      - kickstarts/
      - gitlab-ci.yml
# Generate live media
liveimage:
  stage: build
  before_script:
    - microdnf install -y lorax-lmc-novirt vim-minimal pykickstart sudo
  script:
    - make liveimage
  artifacts:
    paths:
    - build/
    when: always
  rules:
    - changes:
      - kickstarts/
      - gitlab-ci.yml

# deploy live media to server
deploy-iso:
  stage: deploy
  dependencies:
    - iso-budgie
    - iso-cutefish
  before_script:
    - microdnf install -y rclone openssh-clients lorax-lmc-novirt vim-minimal pykickstart sudo make
    - eval $(ssh-agent -s)
    - mkdir -p ~/.ssh
    - ssh-keyscan lapis.ultramarine-linux.org >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - echo "$SSH_PRIVATE_KEY" | ssh-add -
  script:
    - rclone --config=$RCLONE_CONFIG mkdir lapis:/srv/lapis/builds/nightly-$(date +%Y%m%d)
    - rclone --config=$RCLONE_CONFIG -Pv sync build/image/ lapis:/srv/lapis/builds/nightly-$(date +%Y%m%d)

# deploy live media to server
deploy-liveimage:
  stage: deploy
  dependencies:
    - liveimage
  before_script:
    - microdnf install -y rclone openssh-clients lorax-lmc-novirt vim-minimal pykickstart sudo make
    - eval $(ssh-agent -s)
    - mkdir -p ~/.ssh
    - ssh-keyscan lapis.ultramarine-linux.org >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - echo "$SSH_PRIVATE_KEY" | ssh-add -
  script:
    - rclone --config=$RCLONE_CONFIG mkdir lapis:/srv/lapis/results/os
    - rclone --config=$RCLONE_CONFIG -Pv sync build/liveimage/* lapis:/srv/lapis/results/os/