image: registry.fedoraproject.org/fedora-minimal:35
services:
  - docker:dind

stages:
  - build
  - test
  - deploy

iso-budgie:
  stage: build
  script:
    - microdnf install -y lorax-lmc-novirt vim-minimal pykickstart sudo
    - make flagship
  artifacts:
    paths:
    - build/
    when: always

iso-cutefish:
  stage: build
  script:
    - microdnf install -y lorax-lmc-novirt vim-minimal pykickstart sudo
    - make SPIN=cutefish image
  artifacts:
    paths:
    - build/
    when: always

# Generate live media
liveimage:
  stage: build
  before_script:
    - microdnf install -y lorax-lmc-novirt vim-minimal pykickstart sudo
  script:
    - make liveimage
  artifacts:
    paths:
    - build/
    when: always

# deploy live media to server
deploy:
  stage: deploy
  dependencies:
    - liveimage
    - iso-budgie
    - iso-cutefish
  before_script:
    - microdnf install -y rsync openssh-clients lorax-lmc-novirt vim-minimal pykickstart sudo make
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | ssh-add -
  script:
    - rsync -atvR --delete --progress build/liveimage/* gitlab@lapis.ultramarine-linux.org:/srv/lapis/results/ultramarine-35-x86_64
    - rsync -atvR --delete --progress build/image/* gitlab@lapis.ultramarine-linux.org:/srv/lapis/results/nightly/$(date +%Y%m%d)/